PF Library
Copyright (c) Oleg Volchkov
-------------------------------------

CHANGELOG...

Внимание!
---------
Методы для работы с веб-формами еще в разработке и использовать их не стоит. :)
 
0.9.2
-----   
30.03.2009
  1. Теперь в pfCollection.foreach не выдается ошибка при попытке итерации пустой коллекции.

16.03.2009
  1. Рефакторинг pfTemplet. В метод render добавлен ключ $.force, который отменяет кеширование
     и обеспечивает принудительное перекомпилирование шаблона.
     [Нужно, если шаблон вызывается рекурсивно.]

14.03.2009
  1. В класс pfSQL добавлен сбор статистики по общему времени выполнения запросов (stat.queriesTime).

06.01.2009
  1. Библиотека переведена в кодировку UTF-8. Сделаны исправления для обеспечения 
     совместимости с unicode-версией PCRE.  

14.12.2008
  1. Рефакторинг коллекций: 
     В pfArrayList и pfDictionary появилась возможность получать элементы коллекций
     с помощью default getter - dict.key, array.index.
     Теперь проверка существования элемента в массиве и словаре производится через
     встроенную функцию хешей - contains.

13.12.2008
  1. Новый класс pfRequest, который имплементирует логику работы с запросами.
     Вспомогательный класс pfHTTPRequestMeta (прокладка к env).
     Вспомогательный класс pfHTTPRequestHeaders (прокладка к заголовкам запроса),
     теперь можно написать aRequest.HEADERS.User-Agent
  2. Рефакторинг: свойства isSecure, METHOD (переименовано из "method"), isGET, 
     isPOST, isPUT, isDELETE, isHEAD, isAJAX, isSECURE (переимновано из "isSecure") 
     перенесены в pfHTTPRequest. 
  3. Рефакторинг: теперь pfSiteManager использует pfHTTPRequest для обработки запросов.
     Фактически теперь в обработчики передается этот объект, а не хеш.
     Теперь рекомендуется вместо aActionArgs использовать имя aRequest.


12.12.2008
  1. Исправлена ошибка в коде кеширования шаблонов в pfTemplet.

07.12.2008
  1. Доделал переход от метода display к методу render в pfTemplet.
     Теперь рекомендуется везде использовать метод render.
  2. Рефакторинг pfTempletPattern - теперь свойства не компилируются в класс,
     а используется default getter (Парсер 3.3.0).
  3. Теперь переменные добавленные в шаблон объединяются с переменными, переданными
     в метод pfTemplet.render.

01.12.2008
  1. pfCurlFile теперь умеет пропускать заголовок http-ответа с кодом 100 (Сontinue).

17.11.2008
  1. Рефакторинг: компиляция шаблона вынесена в метод pfModule._compileRewritePattern,
     который возвращает хеш с откомпилированным шаблоном и таблицей переменных.
  1. Теперь в pfModule путь к экшну разбивается не только обратный слеш, но и точка.
     Таким образом экшн /one/two.three/ приводит к вызову обработчика onOneTwoThree.
  2. В методе pfModule.addRewritePattern новый параметр aOptions.defaults - хеш, который
     будет добавлен к параметрам экшна.
     ^addRewritePattern[one/:two(/:three)?;test;$.defaults[%.three[default]]]
     test/123 -> $.two[123] $.three[default]
     Удобно использовать для задания дополнительных значений для экшна.
  3. Теперь нет необходимости добавлять к шаблону параметр aOptions.isStatic - если в шаблоне
     нет переменных (:arg), то он автоматически помечается как статический.
  2. Метод pfString.rsplit теперь возвращает пустую таблицу, если не задан текст.

07.11.2008
  1. Теперь для каждого pfSiteModule создается свой собственный экземпляр шаблонного движка (TEMPLET).
     Фактически во вложенные модули теперь передается templetOptions. Это изменение может быть 
     несовместимо со старым кодом.

06.11.2008
  1. Метод pfModule.goTo переименован в pfModule.redirectTo. (Для goTo оставлена заглушка.)
  2. Метод pfSiteModule.display переименован в pfSiteModule.render. (Для display оставлена заглушка.)
  3. Теперь протокол https определятеся по переменной env:HTTPS[on], а уже во вотрую очередь
     по порту (443).
  4. В pfSiteModule добавлены свойства isSecure, method (http-метод), isGET, isPOST, isPUT, 
     isDELETE, isHEAD, isAJAX.
  5. В конструктор класса pfAuthCookie добавлен параметр aOptions.secureCookie.
  6. pfSiteModule теперь добавляет в параметры обработчиков поле $._cookie, содержащее хеш со всеми cookie.
  7. В результирующем хеше ответа экшна pfSiteModule теперь может присутствовать поле $.cookie, 
     содержимое котрого будет передано в куки браузера.
  8. Мелкие правки в pfSiteModule и pfSiteManager.
	
03.11.2008
  1. Метод pfClass.cleanMethodArgument теперь пишет пустой хеш только в неопределенную переменную.
  2. Мелкие правки в pfModule.

30.10.2008
  1. Добавлено и исправлено множество правил в wiki/pfTypografika.

22.09.2008
  1. Новый метод - pfClass.unsafe[aCode;aCatchCode].

14.06.2008
  1. В коллекции добавлена возможность возвращать количество элементов в скалярном контексте.
     ^if($arrayList){...}
     Доступно только в Парсере 3.3.0.

11.05.2008
  1. Новый метод - pfString:format[aFormatString;aValues] 

15.04.2008
  1. Исправлена ошибка с обработкой экспшнов внутри pfSQL.transaction.

17.03.2008
  1. Исправил ошибки при обработке кавычек в модуле pfTypografica, при наличии в тексте тегов.
     А также ошибку обработки троеточия.

16.03.2008
  1. Расширен язык rewrite patterns до "path1/path2/:arg1/(:arg2<regex>(/:{arg3}-arg4)?)?".
     Т.е. теперь можно указывать непостоянные участки урлов "(...)?", но использовать 
     в скобках "или" (|) нельзя.

14.03.2008
  1. Теперь pfAuthCookie умеет получать данные сессии не только из кук, но и из формы.
  2. Рефакторинг pfSiteManager - в отдельные методы вынесена аутентификация и формирование aActionArgs.

12.03.2008
  1. Поправил в sql-классах работу с транзакциями. Теперь поддерживается нормальная работа 
     с транзакционными энжинами.
  2. Теперь в реврайт-паттернах корректно обрабатываются ведущие слеши.
  3. Добавлено несколько асертов.

04.03.2008
  1. Новый метод pfImageMagick.normalize.
  2. Новый метод pfImageMagick.makePreview.
  3. Новый метод pfImageMagick.applyWatermark.

18.02.2008
  1. В pfClass добавлен метод try-finally.
  2. Новый класс - images/pfImageMagick.

30.01.2008
  1. Поправил обработку двойных знаков препинания в pfTypografica.

08.01.2008
  1. pfSiteModule теперь добавляет в параметры обработчиков поля:
     $._files, $._imap, $._qtail.

02.01.2008-08.01.2008
  1. Добавлен класс io/pfCurlFile. 

04.01.2008
  1. В методы класса pfAssert добавлены внятные source для throw.

02.01.2008
  1. Метод pfString:parseURL возращает теперь и оригинальный URL (result.url).
  2. Поправлен класс pfSQL - теперь корректно обрабатывается метод file.sql-string.
     Добавлен метод pfSQL.processQuery.

05.12.2007
  1. Рефакторинг в pfSQL в части кода кеширования. Поправлены мелкие ошибки.
  2. Класс pfSQL теперь умеет автоматически вычислять ключи для кеша и identityMap.

04.12.2007
  1. Метод pfClass.typeOf теперь умеет определять тип переменной с помощью свойства
     CLASS_NAME (появилось в Парсере 3.2.2).

03.12.2007
  1. Теперь для pfCache нужен Парсер не ниже 3.2.2 (в нем исправлен баг с junction).
     Зато теперь не нужно писать хитровывернутый код для получения данных.

01.12.2007
  1. Исправлена ошибка в классе pfCache приводившая к неправильной работе при задании нулевого
     времени кеширования. Поправлены модульные тесты.
  2. В класс pfCache добавлены методы для кеширования типов bool, date, xdoc. 

15.11.2007
  1. Исправлена ошибка в методе pfClass.cleanMethodArgument - не обрабатывался параметр метода.
  2. В класс pfSQL добавлена возможность сохранения результатов запросов в отдельной коллекции.
     При повторном запросе данные обращения к базе или кешу не будет.
     Для включения этой возможности надо передать конструктору $.enableIdentityMap(1).
     Отключить работу с коллекцией можно для любого запроса. Для этого надо передать
     aOptions.isForce(1).
     Ключ вычисляется на основании параметтров запроса (с учетом offset и limit), но можно сформировать
     и свой собственный ключ и передать запросу aOptions.identityMapKey.
  3. Рефакторинг класса pfConsole - теперь он потребляет значительно меньше памяти (строки
     накаплииваются в хеше, а при выдаче формируется единый вывод).

21.10.2007
  1. Если методу pfSiteModule.display передать имя шаблона с ведущим слешем,
     то к его названию не будет подставлен pfSiteModule.templatePath.
     Бывает нужно, если необходимо обратиться к "общему" шаблону.

13.09.2007
  1. Исправлена ошибка в pfSiteModule: подмодулям не передавалась 
     ссылка на sql-класс.

12.09.2007
  1. Модуль pfTypografica теперь умеет прикреплять слова к числам
     и понимает кубические и квадратные м/см. Поправлены мелкие баги.
     

31.08.2007
  1. В pfClass добавлен метод @_abstractMethod[].
  2. Из класса pfString удален метод isEmail - 
     пользуйтесь pfValidate:isValidEmail.
  3. Мелкие рефакторнинги почти во всех классах 
     по следам http://www.parser.ru/forum/?id=62333.
  4. Изменил структуру файлов и папок в web/forms.
     pfWebForm переименован в pfForm.

27.08.2007
  1. В pfClass добавлен метод:
       @defProperty[aPropertyName;aVarName;aType]
       Написаны unit-тесты для него.

  2. В pfClass добавлено два alias'а:
       @defReadProperty[aPropertyName;aVarName]
       @defReadWriteProperty[aPropertyName;aVarName]

  3. В pfClass добавлен метод 
       @cleanMethodArgument[aName]. 
       Надоело в начале методов писать: 
       ^if(!def $aOptions || !($aOptions is hash)){$aOptions[^hash::create[]]}

26.08.2007
  1. Исправлена ошибка в pfModule: неправильно компилировался параметр 
     aOption.source метода assignModule.
     Исправленный модуль добавлен в ветку 0.9.1.

24.08.2007
  1. Начата работа над модулями для работы с web-формами.
     web/forms/
       pfWebForm, pfWFFields, pfWFWidgets

0.9.1
-----

16.08.2007
  1. Написаны методы и тесты для pfValidate:
     @isExistsURL[aString;aOnlyHTTP]
     @isWellFormedXML[aString]
     @isWellFormedXMLFragment[aString]
     @isValidANSIDatetime[aString]

  2. Исправлены ошибки в pfValidate.isValidURL.
  4. Добавлена обработка параметров запроса (?...)
     в pfString.parseURL.

15.08.2007
  1. Написаны методы и тесты для pfValidate:
     @isValidURL[aString;aOnlyHTTP]
  2. Исправлена ошибка в pfString:parseURL - мог обрабатываться
     некоректный URL. 

14.08.2007
  1. Переписан метод pfClass.typeOf - теперь он использует 
     конструкцию "case-when".
  2. Написаны методы и тесты для pfValidate:
       @isValidDouble[aString]  

06.08.2007
  1. Рефакторинг базового класса коллекций (схема итераторов):
      1.1 Добавлены свойства currentIndex и currentItem.
      1.2 Добавлены методы rest, moveNext.
      1.3 Написан универсальный метод foreach.
  2. Проведен рефакторинг классов коллекций для поддержки 
     новой схемы итераторов.
  3. Написаны тесты для коллекций.
  4. Поправлены мелкие баги в классах коллекций.

  Фактически теперь достаточно переопределить в классе-потомке 
  реализацию свойства currentItem, чтобы заработал метод foreach.

  5. Немного почистил папки - удалил модули, которые начинал делать,
     но так и не написал ничего кроме шапки класса. :)

22.07.2007
  1. Написаны методы и тесты для pfValidate:
       @isValidIPV4Address[aString]
       @isValidEmail[aString]

20.07.2007
  1. Начата работа над классом types/pfValidate.
     Подготовлен основа для класса и юнит-тестов.
  2. Написаны методы и тесты для pfValidate:
       @isEmpty[aString]
       @isNotEmpty[aString]
       @isAlphaNumeric[aString]
       @isSlug[aString]
       @isLowerCase[aString]
       @isUpperCase[aString]

19.07.2007
  1. В класс pfString добавлен метод parseURL. Сделан набор тестов.

05.07.2007
  1. В класс pfAuthBase добавлена опция в конструктор $.debugMode - 
     возможность логина без указания пароля.
  2. Мелкие правки кода в pfWikiFormatter и pfTypografica.

03.07.2007
  1. Исправлена ошибка в pfSiteModule.assignModule - добавлены проверка 
     типа aOptions.

23.06.2007
  1. В переменную pfWebModule._templatePath сразу записывается $uriPrefix - 
     теперь шаблоны по-умолчанию имеют структуру урлов.

17.06.2007
  1. В класс pfSQL добавлено свойство stat в котором накапливается статистика
     запросов (пока только $.queriesCount).

12.06.2007
  1. Мелкие правки в коде pfModule и pfSiteModule.
  2. Добавил возможность статических преобразований (описание во вчерашнем логе).
  
11.06.2007
  1. Значительно упростилось создание правил для "реврайта" экшнов.
     1.1 В класс pfModule добавлены методы:
         @addRewritePattern[aPattern;aNewAction;aOptions]
           Добавляем шаблон в карту преобразований.
         @_parseActionByPattern[aPattern;aAction][lPattern;lKeys;lMatches]
           Разбираем экшн на основании шаблона и возвращаем хеш с полученными данными.
         Карта преобразований лежит в переменной  $pfModule._rewriteMap (pfArrayList). 
     1.2 Метод pfModule.rewriteAction теперь умеет искать соответствия в карте 
         преобразований и реврайтить экшны.
     1.3 Шаблоны (patterns) для преобразований имеют следующий "язык":
         path1/(path2|path3)/:arg1/:arg2<regex>/:{arg3}-arg4
         :arg - имя переменной в выходном хеше
         <regex> - регулярное выражение, которое уточняет формат в котором должна 
                   прийти переменная.
         (path|path3) - выражение, которое интерпретируется как регулярное выражение, 
                        при этом левая скобка будет заменена на "(?:". 
                        Не рекомендуется использовать! 
                        Возможно будет исключено в следующих версиях, поскольку затрудняет
                        обратное преобразование урлов.
         :{arg4} - аналогично штатному синтаксису Парсера, отделяет имя переменной от
                   ненужных символов.
     1.4 Пример.
         На входе имеем экшн: traffic/10.10.10.1/2007/5/31
         В конструкторе прописываем паттерны:         
           $lIPPattern[\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}]
           ^addRewritePattern[traffic/:ip<$lIPPattern>;traffic]
           ^addRewritePattern[traffic/:ip<$lIPPattern>/:year<\d{4}>;traffic]
           ^addRewritePattern[traffic/:ip<$lIPPattern>/:year<\d{4}>/:month<\d{1,2}>;traffic]
           ^addRewritePattern[traffic/:ip<$lIPPattern>/:year<\d{4}>/:month<\d{1,2}>/:day<\d{1,2}>;traffic]
         После реврайта (в последнем случае - в остальных полей будет поменьше) получим хеш:
           $.action[traffic]
           $.args[$.ip[10.10.10.1] $.year[2007] $.month[5] $.day[31]]
     1.5 Возможны статические преобразования. Если при добавлении шаблона указать опцию 
         $aOptions.isStatic(1), то шаблон будет считаться регулярным выражением, 
         которое должно совпать с экшном. При этом из экшна не будут "выкусываться" никакие 
         переменные, а редирект пройдет на $aNewAction, а вкачестве аргументов 
         для обработчика будут использованы $aOptions.args.
         Будьте очень аккуратны с этой возможнотью!
     1.6 Если будет необходимо сделать специфическое преобразование, то просто перекрываем 
         pfModule.rewriteAction.
              
24.05.2007
  1. Убрал лишние строки в выдаче шаблона Темплета (не везде стоял result).

13.05.2007
  1. Дополнена схема обработки событий в pfSiteModule: теперь в модуле есть служебное
     событие onINDEX, которое вызывается, как обработчик "по-умолчанию" для экшнов
     без обработчиков. Если в модуле определен обработчик onNOTFOUND, то он он вызывается
     для всех неизвестных экшнов, кроме корневого ("/").
 
30.04.2007
  1. Теперь pfSiteManager определяет протокол по которому работает пользователь (http|https)
     на основании переменной $env:SERVER_PORT (443 порт == https; тестировалось на Апаче).

0.9.0
-----

26.03.2007
  1. В pfSiteModule добавлена схема "post dispatch". Теперь можно определять собственные
     обработчики результата выполнения метода dispatch.
     Любой обработчик ("onDo") может возвратить хеш [$.type $.body], который будет 
     передан методам "postTYPE" или "postDEFAULT". Если методы не найдены, то никакая 
     обработка не проводится.
     Если из обработчика вернулся не хеш (или хеш без поля type), то ответ "заворачивается"
     в хеш и передается обработчику. Для строк и чисел полю type присваивается значение
     $responseType, для всего остального - "unknown".
  2. В класс pfSiteModule добавлено свойство responseType (описание см. выше).
  3. Перевел pfSiteManager на использование схемы "post dispatch". Теперь менеджер
     обрабатывает ответы "html", "xml", "text", "file".  

15.03.2007
  1. Провел рефакторинг кода "модулей". В классе pfModule очищен метод goTo - 
     теперь его реализация полностью легла на плечи программиста.
     В классах pfSiteModule и pfSiteManager реализован новый механизм редиректа:
     теперь метод goTo вызывает эксепшн, а ловит его диспетчер в менеджере.
  2. Переделал механизм обработки урлов при редиректе - теперь используется только
     таинтинг, без матчей.

25.02.2007
  1. Сделал в pfSiteManager объединение $form:fields и $form:tables.
     Теперь в $aActionArgs._tables попадает содержимое $form:tables.

26.01.2007
  1. Рефакторинг pfSiteModule: вызов фабрик вынесен в свойства.
     В опции конструктора добавлена переменная sqlConnectString.

23.01.2007
  1. В класс pfSiteModule добавлены методы assignVar, display 
     и свойство templatePath. Это прокладки до соответствующих
     методов объекта TEMPLET.
     Теперь в обработчиках экшнов можно просто написать 
     ^display[main] вместо ^TEMPLET.display[/path/to/template/main.pt] 
     и ^assignVar[name;value] вместо ^TEMPLET.assign[name;value].
     Важно! Если в методе display не задано имя шаблона, то считаем, 
     что имя шаблона "default".
  2. Произведен рефакторинг классов pfSiteModule и pfSiteManager.
     Устранено сильное дублированеи кода.

18.01.2007
  1. Добавлен класс pfScroller. Фактически класс-адаптер 
     для класса скроллера Михаила Петрушина.
  2. Дописал несколько "правил" в CODESTYLE.

13.01.2007
  1. Метод pfModule.dispatcher переименован в pfModule.dispatch. 
  2. Немного изменена логика работы pfModule.dispatch: если в модуле
     определен экшн с именем модуля (onModule), то зовем экшн, а не метод
     dispatch модуля. 
  3. Рефакторинг Templet'а - вставил использование pfAssert в методах.

09.01.2007
  1. Добавлен класс collections/pfDictionary, реализующий
     упорядоченный хэш (словарь).
  2. Во все коллекции добавлен метод clear, очищающий коллекцию.

28.11.2006
  1. Добавлен класс auth/pfAuthApache, обрабатывающий штатную 
     Апачевскую авторизацию.
  2. Исправлены пути к pfCache.p в некоторых модулях.

06.11.2006
  1. Рефакторинг коллекций: сделан супер-класс pfCollection, 
     добавлена возможность импорта коллекции в контсрукторе.
  2. В класс pfAssert добавлен метод pass.
  3. В sql-классы добавлена работа с серверными транзакциями. 
     В базовый класс перенесены методы для унификации запросов.

05.11.2006
  1. Изменена структура библиотеки - все классы убраны в тематические папки.
  2. Все (кроме статических) классы сделаны наследниками pfClass.
  3. В дистрибутив добавлена лицензия (pf/LICENSE).
  4. Написан черновик "стандартов кодирования" (pf/CODESTYLE).
  5. Добавлен класс collections/pfQueue.

03.11.2006
  1. Добавлен класс collections/pfArrayList.

02.11.2006
  1. Начата работа над системой юнит-тестов. 
     tests/pfTestCase
     tests/pfAssert
  2. Добавлен класс pfConsole.
  3. Сделан рефакторинг класса collections/pfStack (теперь как хранилище используется хэш).

06.10.2006
  1. Сделано кеширование результатов в pfSQL.
  2. Поправлены мелкие ошибки в pfCache.

24.09.2006
  0. Давно уже надо было вести лог... :)
  1. Добавлен класс pfOS (функции для работы с файловыми системами).
  2. Добавлен класс pfBrowser.
  3. Переделал в паре мест дефолтные фабрики.
  4. В класс pfString добавлен метод dec2bin.
  
  